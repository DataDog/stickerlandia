# user-management mise tasks

[tasks."build:local"]
description = "Build .NET solution"
run = "dotnet build"

[tasks."build:docker-dev"]
description = "Build dev container"
run = """
ARCH=${ARCH:-$(uname -m | sed 's/x86_64/amd64/')}
docker build --platform linux/$ARCH -f src/Stickerlandia.UserManagement.Api/Dockerfile -t stickerlandia/user-management-service:dev .
docker build --platform linux/$ARCH -f src/Stickerlandia.UserManagement.Api/Dockerfile -t stickerlandia/user-management-worker:dev .
docker build --platform linux/$ARCH -f src/Stickerlandia.UserManagement.Api/Dockerfile -t stickerlandia/user-management-migration:dev .
"""

[tasks."build:docker-release"]
description = "Build release container"
run = """
ARCH=${ARCH:-$(uname -m | sed 's/x86_64/amd64/')}
docker build --platform linux/$ARCH -f src/Stickerlandia.UserManagement.Api/Dockerfile -t stickerlandia/user-management-service:latest .
docker build --platform linux/$ARCH -f src/Stickerlandia.UserManagement.Api/Dockerfile -t stickerlandia/user-management-worker:latest .
docker build --platform linux/$ARCH -f src/Stickerlandia.UserManagement.Api/Dockerfile -t stickerlandia/user-management-migration:latest .
"""

[tasks."infra:install"]
description = "Install CDK dependencies"
dir = "infra/aws"
sources = ["package-lock.json"]
outputs = ["node_modules/.package-lock.json"]
run = "npm ci"

[tasks."aws:deploy"]
description = "Deploy to AWS"
dir = "infra/aws"
depends = ["infra:install"]
run = "npx cdk deploy --require-approval never"

[tasks."aws:deploy:local"]
description = "Deploy to AWS (build container locally)"
depends = ["//:env:setup"]
env = { DEPLOY_MODE = "local" }
run = "mise run aws:deploy"

[tasks."aws:deploy:release"]
description = "Deploy to AWS using prebuilt GHCR images"
depends = ["//:env:setup"]
env = { DEPLOY_MODE = "release" }
run = "mise run aws:deploy"

[tasks."aws:down"]
description = "Destroy AWS stack"
dir = "infra/aws"
depends = ["infra:install"]
run = "npx cdk destroy --force"

[tasks."aws:info"]
description = "Show AWS stack outputs"
run = """
echo "=== UserService-$ENV ==="
aws cloudformation describe-stacks \
  --stack-name "UserService-$ENV" \
  --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue]' \
  --output table 2>/dev/null || echo "Stack not deployed"
"""
