# Unless explicitly stated otherwise all files in this repository are licensed under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2025-Present Datadog, Inc.

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    ports:
      - "8080:80"     # App traffic
      - "8081:8080"   # Dashboard
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --entrypoints.web.address=:80
      - --entrypoints.dashboard.address=:8081
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/entrypoints"]
      interval: 1s
      timeout: 10s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=PathPrefix(`/dashboard`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=dashboard"

  redpanda:
    image: redpandadata/redpanda:latest
    container_name: stickerlandia-redpanda
    command:
      - redpanda
      - start
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --overprovisioned
      - --node-id=0
      - --check=false
      - --pandaproxy-addr=0.0.0.0:8082
      - --advertise-pandaproxy-addr=redpanda:8082
      - --kafka-addr=0.0.0.0:9092
      - --advertise-kafka-addr=redpanda:9092
      - --rpc-addr=0.0.0.0:33145
      - --advertise-rpc-addr=redpanda:33145
      - --mode dev-container
    ports:
      - "9092:9092"
      # - "8082:8082"
      - "9644:9644"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 1s
      timeout: 10s
      retries: 5

  redpanda-init:
    image: redpandadata/redpanda:latest
    container_name: redpanda-init
    depends_on:
      redpanda:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "rpk topic create users.userRegistered.v1 users.stickerClaimed.v1 users.userDetailsUpdated.v1 stickers.stickerAssignedToUser.v1 stickers.stickerRemovedFromUser.v1 stickers.stickerAdded.v1 stickers.stickerUpdated.v1 stickers.stickerDeleted.v1 --brokers redpanda:9092 || true"
    restart: "no"

  redpanda-console:
    image: redpandadata/console:latest
    container_name: stickerlandia-redpanda-console
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "8082:8080"
    environment:
      KAFKA_BROKERS: redpanda:9092
      # REDPANDA_ADMIN_API_URLS: http://redpanda:9644
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 1s
      timeout: 10s
      retries: 5

  user-management-db:
    image: postgres:16
    container_name: user-management-db
    environment:
      POSTGRES_DB: user_management
      POSTGRES_USER: user_mgmt_user
      POSTGRES_PASSWORD: user_mgmt_password
    ports:
      - "5433:5432"
    volumes:
      - user-management-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_mgmt_user -d user_management"]
      interval: 1s
      timeout: 10s
      retries: 5

  user-management:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user-management
    depends_on:
      user-management-db:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      user-management-db-migrations:
        condition: service_completed_successfully
    environment:
      # DataDog APM configuration
      DD_SERVICE: user-management
      DD_ENV: development
      DD_VERSION: ${COMMIT_SHA:-latest}
      DD_AGENT_HOST: datadog-agent
      DD_DATA_STREAMS_ENABLED: true
      DD_TRACE_OTEL_ENABLED: "true"
      DD_LOGS_INJECTION: "true"
      DD_RUNTIME_METRICS_ENABLED: "true"
      # Application configuration
      ASPNETCORE_ENVIRONMENT: Development
      DRIVING: AGNOSTIC
      DRIVEN: AGNOSTIC
      DISABLE_SSL: "true"
      ConnectionStrings__messaging: "redpanda:9092"
      ConnectionStrings__database: "Host=user-management-db;Port=5432;Database=user_management;Username=user_mgmt_user;Password=user_mgmt_password"
      KAFKA__BOOTSTRAPSERVERS: "redpanda:9092"
      KAFKA__SCHEMAREGISTRY: "http://redpanda:8082"
      KAFKA__GROUPID: "stickerlandia-user-management"
      OPENIDDICT_ISSUER: ${DEPLOYMENT_HOST_URL}
      # DEPLOYMENT_HOST_URL: ${DEPLOYMENT_HOST_URL}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/users/v1/health"]
      interval: 1s
      timeout: 15s
      retries: 10
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-management.rule=PathPrefix(`/api/users`)"
      - "traefik.http.routers.user-management.priority=100"
      - "traefik.http.routers.auth.rule=PathRegexp(`(?i)^/auth`)"
      - "traefik.http.routers.auth.priority=100"
      - "traefik.http.services.user-management.loadbalancer.server.port=8080"

  user-management-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user-management-worker
    depends_on:
      user-management-db:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      # DataDog APM configuration
      DD_SERVICE: user-management-worker
      DD_ENV: development
      DD_VERSION: ${COMMIT_SHA:-latest}
      DD_AGENT_HOST: datadog-agent
      DD_DATA_STREAMS_ENABLED: true
      DD_TRACE_OTEL_ENABLED: "true"
      DD_LOGS_INJECTION: "true"
      DD_RUNTIME_METRICS_ENABLED: "true"
      ASPNETCORE_ENVIRONMENT: Development
      DRIVING: AGNOSTIC
      DRIVEN: AGNOSTIC
      ConnectionStrings__messaging: "redpanda:9092"
      ConnectionStrings__database: "Host=user-management-db;Port=5432;Database=user_management;Username=user_mgmt_user;Password=user_mgmt_password"
      KAFKA__BOOTSTRAPSERVERS: "redpanda:9092"
      KAFKA__SCHEMAREGISTRY: "http://redpanda:8082"
      KAFKA__GROUPID: "stickerlandia-user-management"
    command: ["worker/Stickerlandia.UserManagement.Worker.dll"]

  user-management-db-migrations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user-management-migrations
    depends_on:
      user-management-db:
        condition: service_healthy
    environment:
      # DataDog APM configuration
      DD_SERVICE: user-management-migration-service
      DD_ENV: development
      DD_VERSION: ${COMMIT_SHA:-latest}
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_OTEL_ENABLED: "true"
      DD_LOGS_INJECTION: "true"
      DD_RUNTIME_METRICS_ENABLED: "true"
      ASPNETCORE_ENVIRONMENT: Development
      DRIVING: AGNOSTIC
      DRIVEN: AGNOSTIC
      ConnectionStrings__messaging: "redpanda:9092"
      ConnectionStrings__database: "Host=user-management-db;Port=5432;Database=user_management;Username=user_mgmt_user;Password=user_mgmt_password"
      KAFKA__BOOTSTRAPSERVERS: "redpanda:9092"
      KAFKA__SCHEMAREGISTRY: "http://redpanda:8082"
      KAFKA__GROUPID: "stickerlandia-user-management"
      DEPLOYMENT_HOST_URL: ${DEPLOYMENT_HOST_URL}
    command: ["migrations/Stickerlandia.UserManagement.MigrationService.dll"]

  datadog-agent:
    image: datadog/agent:7
    container_name: datadog-agent
    profiles:
      - monitoring
    environment:
      # Core Datadog configuration
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.eu}
      - DD_HOSTNAME=stickerlandia-dev
      - DD_TAGS=env:development,project:stickerlandia
      
      # APM (Application Performance Monitoring) configuration
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_APM_RECEIVER_PORT=8126
      
      # Log collection configuration
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_LOGS_CONFIG_AUTO_MULTI_LINE_DETECTION=true
      
      # Container monitoring
      - DD_CONTAINER_EXCLUDE_LOGS=name:datadog-agent
      - DD_CONTAINER_EXCLUDE_METRICS=name:datadog-agent
      
      # OTLP configuration for OpenTelemetry
      - DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_GRPC_ENDPOINT=0.0.0.0:4317
      - DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_HTTP_ENDPOINT=0.0.0.0:4318
      
      # Docker integration
      - DD_DOCKER_LABELS_AS_TAGS=true
      - DD_DOCKER_ENV_AS_TAGS=true
    volumes:
      # Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # System directories for host metrics
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "agent", "health"]
      interval: 2s
      timeout: 30s
      retries: 20
      start_period: 40s

volumes:
  user-management-data:
  redpanda-data:
