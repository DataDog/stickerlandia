# Unless explicitly stated otherwise all files in this repository are licensed under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2025-Present Datadog, Inc.

name: Build Go

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.21'
      working-directory:
        description: 'Working directory for the service'
        required: true
        type: string
      run-codeql:
        description: 'Whether to run CodeQL analysis'
        required: false
        type: boolean
        default: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@cdcb36043654635271a94b9a6d1392de5bb323a7 # v5.0.1
        with:
          go-version: ${{ inputs.go-version }}
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      - name: Download dependencies
        run: |
          cd ${{ inputs.working-directory }}
          go mod download

      - name: Build
        run: |
          cd ${{ inputs.working-directory }}
          go build -v ./...

      - name: Run Unit Tests
        run: |
          cd ${{ inputs.working-directory }}
          make test

      - name: Run Integration Tests
        run: |
          cd ${{ inputs.working-directory }}
          make test-integration

      - name: Run Go Vet
        run: |
          cd ${{ inputs.working-directory }}
          go vet ./...

      - name: Run Go Fmt Check
        run: |
          cd ${{ inputs.working-directory }}
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted properly:"
            gofmt -s -l .
            exit 1
          fi

      - name: Install CodeQL CLI
        if: ${{ inputs.run-codeql }}
        run: |
          wget -q https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql-linux64.zip
          unzip -q codeql-linux64.zip
          sudo mv codeql /opt/codeql
          echo "/opt/codeql" >> $GITHUB_PATH
          /opt/codeql/codeql version --format=text

      - name: Create CodeQL Database
        if: ${{ inputs.run-codeql }}
        run: |
          cd ${{ inputs.working-directory }}
          codeql database create cql-db --language=go --source-root=.
